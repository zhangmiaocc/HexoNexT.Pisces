---
title: å¼€ç®±å³ç”¨çš„è‡ªå®šä¹‰Banner
tags:
  - Android
  - Banner
  - View
categories:
  - Android
  - View
abbrlink: 108df6b8
date: 2019-08-19 17:59:59
---

![](https://raw.githubusercontent.com/zhangmiaocc/blogImageResource/master/img/640112319204sda.gif)

<!--more-->

## è‡ªå®šä¹‰Bannerç”¨æ³•æ˜ç»†

æ”¯æŒXMLè‡ªå®šä¹‰å±æ€§ï¼š

- bv_viewHeightï¼šBannerè§†å›¾åŒºåŸŸçš„é«˜åº¦ï¼Œå°äºç­‰äº0æ—¶ä¸ºè¯¥å¸ƒå±€çš„é«˜åº¦

- bv_viewCornerRadiusï¼šè§†å›¾åŒºåŸŸåœ†è§’çš„åŠå¾„

- bv_itemViewWidthRatioï¼šæ ¹æ®è¯¥å¸ƒå±€å®½åº¦çš„ç™¾åˆ†æ¯”è®¾ç½®ItemViewçš„å®½åº¦

- bv_itemViewMarginï¼šè®¾ç½®ItemViewä¹‹é—´çš„é—´è·

- bv_intervalInMillisï¼šBannerè½®æ¢æ—¶é—´ï¼ˆåœ¨SMOOTHæ¨¡å¼ä¸‹ä¸ºBannerä»å³åŒ€é€Ÿåˆ°å·¦çš„æ—¶é—´ï¼‰

- bv_pageHoldInMillisï¼šæ‰‹æŒ‡æ»‘åŠ¨åï¼Œé¡µé¢åœç•™çš„æ—¶é•¿ï¼ˆåªåœ¨SMOOTHæ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼‰

- bv_scrollModeï¼šè®¾ç½®Banneræ»šåŠ¨æ¨¡å¼

- - INTERVALï¼šé—´éš”åˆ‡æ¢æ¨¡å¼
  - SMOOTHï¼šåŒ€é€Ÿæ»šåŠ¨æ¨¡å¼

- bv_itemViewAlignï¼šItemViewä¸çˆ¶WrapperViewçš„å¯¹é½æ–¹å¼ï¼ˆå†³å®šäº†itemViewMarginçš„ç•™ç™½ä½ç½®ï¼‰

- - CENTER_HORIZONTALï¼šæ°´å¹³å±…ä¸­
  - ALIGN_PARENT_LEFTï¼šå±…å·¦å¯¹é½
  - ALIGN_PARENT_RIGHTï¼šå±…å³å¯¹é½

æš´éœ²çš„APIæœ‰ï¼š

- setBannerViewImpl(impl: IBannerView)ï¼šè®¾ç½®Bannerå¿…é¡»çš„å®ç°ç±»
- startAutoScroll()ï¼šå¼€å§‹è‡ªåŠ¨æ»šåŠ¨ï¼ˆé¡µé¢æ•°é‡å°äº1æ—¶ä¸ä¼šæ»šåŠ¨ï¼‰
- stopAutoScroll()ï¼šåœæ­¢è‡ªåŠ¨æ»šåŠ¨

```java
/**
 * å®šä¹‰é¡µé¢åˆ‡æ¢å›è°ƒ
 */
interface OnPageChangeListener {
    fun onPageSelected(position: Int)
}

interface IBannerViewBase {
    fun getCount(): Int

    fun getItemView(context: Context): View

    fun onBindView(itemView: View, position: Int)
}

/**
 * BannerViewä¾èµ–çš„å¤–éƒ¨å®ç°
 */
interface IBannerView : OnPageChangeListener, IBannerViewBase {

    /**
     * å½“countä¸º0æ—¶çš„é»˜è®¤view
     */
    fun getDefaultView(context: Context): View? {
        return null
    }

    /**
     * é»˜è®¤å…³é—­è‡ªåŠ¨æ»šåŠ¨
     */
    fun isDefaultAutoScroll(): Boolean {
        return false
    }

    override fun onPageSelected(position: Int) {}
}
```

æºç åœ°å€ï¼š

> https://github.com/drawf/SourceSet/tree/master/app/src/main/java/me/erwa/sourceset/view/banner

## æ€è€ƒåˆ†æ

**NOTEï¼š**è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸“æ³¨äºBannerViewçš„å°è£…ä¸å®ç°ï¼Œå…³äºæ›´åº•å±‚çš„PagerSnapHelperçš„åŸç†éƒ¨åˆ†ä¸åœ¨èŒƒå›´å†…ï¼Œä½†åœ¨æ–‡æœ«æˆ‘**æ‹œè¯»çš„æ–‡ç« **ä¸­è´´å‡ºäº†ä¸€ä»½é“¾æ¥ï¼Œå¤§å®¶å¯è‡ªè¡Œé£Ÿç”¨ã€‚

å‰è·¯æ¼«æ¼«ï¼Œæˆ‘ä»¬å…ˆæ¢³ç†ä¸‹éœ€æ±‚ï¼š

1. è¦æ”¯æŒä¸¤ç§æ»šåŠ¨æ¨¡å¼ï¼Œé—´éš”åˆ‡æ¢ã€å¹³æ»‘æ»šåŠ¨
2. è¦æ”¯æŒè®¾ç½®è§†å›¾åŒºåŸŸåœ†è§’
3. è¦æ”¯æŒè®¾ç½®æ¡ç›®è§†å›¾åœ†è§’ï¼ˆItemViewï¼‰ï¼ˆè¯¥éœ€æ±‚æœ¬æ¬¡æœªåšå®ç°ï¼Œä¸‹æ–‡ä¼šè‡ªåŠ¨å¿½ç•¥è¯¥éœ€æ±‚ï¼‰
4. è¦æ”¯æŒæ— é™å¾ªç¯æ»šåŠ¨
5. è¦æ”¯æŒæ ¹æ®BannerViewçš„å®½çš„æ¯”å€¼è®¾ç½®ItemViewçš„å®½
6. è¦æ”¯æŒè®¾ç½®ItemViewä¹‹é—´çš„é—´è·
7. è¦æ”¯æŒè®¾ç½®æ»šåŠ¨é—´éš”ï¼ŒåŒ€é€Ÿæ¨¡å¼è¦æ”¯æŒè®¾ç½®æ»šåŠ¨ä¸€é¡µçš„æ—¶é—´
8. è¦æ”¯æŒè®¾ç½®åŒ€é€Ÿæ¨¡å¼ä¸‹ï¼Œæ‰‹æŒ‡æ»‘åŠ¨åï¼Œé¡µé¢åœç•™çš„æ—¶é•¿
9. è¦æ”¯æŒè®¾ç½®ItemViewä¸çˆ¶WrapperViewçš„å¯¹é½æ–¹å¼ï¼ˆå†³å®šäº†itemViewMarginçš„ç•™ç™½ä½ç½®ï¼‰
10. è¦æ”¯æŒè®¾ç½®é»˜è®¤æ˜¯å¦å¼€å¯æ»šåŠ¨
11. è¦æ”¯æŒè®¾ç½®æ•°æ®æºä¸ºç©ºæ—¶çš„é»˜è®¤View
12. è¦æ”¯æŒæ•°æ®æºåªæœ‰1å¼ banneræ—¶ï¼Œç¦æ­¢æ»šåŠ¨
13. è¦æš´éœ²APIæ§åˆ¶Bannerçš„è‡ªåŠ¨æ»šåŠ¨ä¸æš‚åœ
14. è¦æ”¯æŒè®¾ç½®æŒ‡ç¤ºå™¨ï¼ˆIndicatorï¼‰ï¼Œä¸”èƒ½çµæ´»æ§åˆ¶æŒ‡ç¤ºå™¨ä½ç½®ï¼Œä¸”ä¸BannerViewè§£è€¦

ğŸ¤©è¿™ä¹ˆå¤šéœ€æ±‚ï¼Œä¸è¦æ€•ï¼Œæˆ‘ä»¬æ ¹æ®éœ€æ±‚æ¥ç†ä¸€éæ ¸å¿ƒæŠ€æœ¯ç‚¹ï¼š

1. `å¹³æ»‘æ»šåŠ¨æ¨¡å¼`å¯ä»¥ä½¿ç”¨RecyclerView+PagerSnapHelperå®ç°ï¼Œ`é—´éš”æ»šåŠ¨æ¨¡å¼`å¯ä»¥ç»§ç»­ä½¿ç”¨ViewPagerå®ç°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‰è€…æ–¹å¼å®ç°ã€‚ï¼ˆæœ¬æ–‡ç»Ÿä¸€ä½¿ç”¨RecyclerView+PagerSnapHelperæ–¹å¼ï¼Œä¸è¿‡ä»£ç ä¸­ä¹Ÿç•™å‡ºäº†æ¥å£ï¼Œå¯ç”¨ViewPageråšå®ç°ï¼‰
2. è®¾ç½®åœ†è§’è¿˜æ˜¯é‡‡ç”¨`Xfermode`åšè£å‰ªåˆæˆå³å¯ã€‚ï¼ˆè¯¥æ–¹å¼åœ¨ä¹‹å‰çš„æ–‡ç« **ShadowLayout**ä¸­ä½¿ç”¨è¿‡ï¼Œæ•…æœ¬æ–‡ä¸å†èµ˜è¿°ï¼‰
3. éœ€æ±‚[4]å°†adpterä¸­getItemCount()è¿”å›Int.MAX_VALUEï¼Œå†åœ¨ç»‘å®šViewæ—¶å€™ï¼Œç”¨å½“å‰çš„positionä¸çœŸå®countæ±‚ä½™æ•°ï¼Œä½œä¸ºçœŸå®çš„positionå»ç»‘å®šæ•°æ®ï¼Œå³å¯å®ç°ã€‚
4. éœ€æ±‚[4]åˆ°[13]ï¼Œéƒ½æ²¡æœ‰æŠ€æœ¯å¤æ‚åº¦ï¼Œä½†æœ‰ä¸šåŠ¡å¤æ‚åº¦ï¼Œåšå¸¸è§„å®ç°å³å¯ã€‚
5. éœ€æ±‚[14]å¯å®šä¹‰Indicatoræ¶‰åŠçš„æ¥å£åšä»£ç è§£è€¦ï¼Œå¹¶å°†BannerViewç»§æ‰¿RelativeLayoutï¼Œè¿™æ ·Indicatorä½œä¸ºå­Viewåœ¨xmlä¸­å¯çµæ´»æ§åˆ¶ä½ç½®ã€‚

è¿™æ ·ä¸€æ¥ï¼Œå®ç°æˆ‘ä»¬æƒ³è¦çš„BannerViewåªæ˜¯è€å¿ƒ+æ—¶é—´çš„é—®é¢˜äº†ã€‚ä»¥ä¸‹ï¼Œæˆ‘ä¼šæŒ‘æœ¬æ¬¡å®ç°ä¸­é‡è¦çš„å‡ ç‚¹æ¥åšè¯´æ˜ï¼Œå¦‚ä¸‹ï¼š

1. RecyclerView+PagerSnapHelperå®ç°çš„**PagerRecyclerView**
2. ç”ŸæˆPagerViewå®ä¾‹çš„å·¥å‚**PagerViewFactory**
3. Indicatorçš„è§£è€¦å®ç°

## PagerRecyclerView

çœ‹åå­—ä¾¿çŸ¥è¿™æ˜¯ä¸€ä¸ªç”¨RecyclerViewå®ç°ViewPageråŠŸèƒ½çš„ç±»ï¼Œæ‰€ä»¥ç»§æ‰¿è‡ªRecyclerViewã€‚

å®ƒä½œä¸ºBannerViewçš„æ ¸å¿ƒåŠŸèƒ½å®ç°ç±»ï¼Œä¸ºäº†ä¸ä¸Šå±‚è§£è€¦ï¼ˆä¹Ÿå°±æ˜¯æ–¹ä¾¿åˆ‡æ¢ä¸ºå…¶å®ƒå®ç°ï¼Œæ¯”å¦‚ç”¨ViewPageråšå®ç°ï¼‰æ‰€ä»¥å®šä¹‰æ¥å£`IPagerViewInstance`ã€‚

```java
/**
 * PagerViewåŠŸèƒ½å®ä¾‹éœ€å®ç°çš„æ¥å£
 */
interface IPagerViewInstance {

    /**
     * è®¾ç½®è‡ªåŠ¨æ»šåŠ¨
     * @param intervalInMillis: Int åœ¨INTERVALæ¨¡å¼ä¸‹ä¸ºé¡µé¢åˆ‡æ¢é—´éš” åœ¨SMOOTHæ¨¡å¼ä¸‹ä¸ºæ»šåŠ¨ä¸€é¡µæ‰€éœ€æ—¶é—´
     */
    fun startAutoScroll(intervalInMillis: Int)

    /**
     * åœæ­¢è‡ªåŠ¨æ»šåŠ¨
     */
    fun stopAutoScroll()

    /**
     * è·å–å½“å‰Itemçš„ä½ç½®ï¼ˆListçš„ç´¢å¼•ï¼‰
     */
    fun getCurrentPosition(): Int

    /**
     * è·å–å½“å‰çœŸå®çš„Itemçš„ä½ç½®ï¼ˆListçš„ç´¢å¼•ï¼‰
     */
    fun getRealCurrentPosition(realCount: Int): Int

    /**
     * è®¾ç½®å¹³æ»‘æ¨¡å¼æ˜¯å¦å¼€å¯ï¼Œå¦åˆ™ä¸ºé—´éš”åˆ‡æ¢æ¨¡å¼
     */
    fun setSmoothMode(enabled: Boolean)

    /**
     * è®¾ç½®é¡µé¢åœç•™æ—¶é•¿
     */
    fun setPageHoldInMillis(pageHoldInMillis: Int)

    /**
     * è®¾ç½®é¡µé¢åˆ‡æ¢å›è°ƒ
     */
    fun setOnPageChangeListener(listener: OnPageChangeListener)

    /**
     * é€šçŸ¥æ•°æ®åˆ·æ–°
     */
    fun notifyDataSetChanged()
}
```

å…³äº`PagerSnapHelper`çš„ä½¿ç”¨æå…¶ç®€å•ï¼Œåªéœ€åˆ›å»ºå‡ºå®ä¾‹ï¼ŒattachToRecyclerViewä¸€ä¸‹ï¼Œå³å¯è®©RecyclerViewæ‘‡èº«ä¸€å˜æˆä¸ºViewPagerä¸€æ ·ã€‚ï¼ˆè¿™é‡Œå®åœ¨è®©äººæƒŠå¹ï¼ï¼æˆ‘ä»¬éƒ½åº”è¯¥è¿½æ±‚è¿™ç§APIçš„æè‡´è®¾è®¡ï¼‰

```java
/**
 * æ»‘åŠ¨åˆ°å…·ä½“ä½ç½®å¸®åŠ©å™¨
 */
private var mSnapHelper: PagerSnapHelper = PagerSnapHelper()
... çœç•¥ä»£ç 
init {
    mSnapHelper.attachToRecyclerView(this)
    ... çœç•¥ä»£ç 
}
```

å…³äº`é—´éš”åˆ‡æ¢æ¨¡å¼ åŒ€é€Ÿæ»šåŠ¨æ¨¡å¼`çš„å®ç°ä¸»è¦æ˜¯åœ¨`startTimer()`æ–¹æ³•ä¸­ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºTimerçš„é—´éš”æ—¶é—´ä¸åŒã€å›è°ƒä¸­æ‰§è¡Œçš„æ–¹æ³•ä¸åŒã€‚å…¶ä¸­åŒ€é€Ÿæ¨¡å¼çš„Timeré—´éš”æ—¶é—´éœ€è¦ä½¿ç”¨`å¤–éƒ¨è®¾ç½®çš„æ»šåŠ¨ä¸€å±çš„æ—¶é—´ã€ä¸€å±çš„å®½åº¦ã€æ¯æ¬¡scrollByçš„è·ç¦»`è®¡ç®—è€Œæ¥ã€‚

```java
/**
 * å¼€å§‹å®šæ—¶å™¨
 */
private fun startTimer() {
    mTimer?.cancel()
    if (mWidth > 0 && mFlagStartTimer && context != null && context is Activity) {
        mTimer = timer(initialDelay = mDelayedTime, period = mPeriodTime) {
            if (mScrollState == SCROLL_STATE_IDLE) {
                (context as Activity).runOnUiThread {
                    if (mSmoothMode) {
                        scrollBy(DEFAULT_PERIOD_SCROLL_PIXEL, 0)
                        triggerOnPageSelected()
                    } else {
                        smoothScrollToPosition(++mOldPosition)
                        mPageChangeListener?.onPageSelected(mOldPosition)
                    }
                }
            }
        }
    }
}

override fun onSizeChanged(w: Int, h: Int, oldw: Int, oldh: Int) {
    super.onSizeChanged(w, h, oldw, oldh)
    mWidth = (w - paddingLeft - paddingRight).toFloat()
    mHeight = (h - paddingTop - paddingBottom).toFloat()

    //è®¡ç®—åŒ€é€Ÿæ»šåŠ¨çš„æ—¶é—´é—´éš”
    if (mSmoothMode) {
        mPeriodTime = (mSmoothSpeed / (mWidth / DEFAULT_PERIOD_SCROLL_PIXEL)).toLong()
    }

    if (mTimer == null) {
        startTimer()
    }
}
```

**é¡µé¢é€‰ä¸­**æ˜¯æ ¹æ®PagerSnapHelperä¸­æä¾›çš„findSnapViewæ–¹æ³•ï¼Œå…ˆæ‰¾åˆ°Snapï¼ˆå°±æ˜¯å½“å‰çš„ç›®æ ‡Viewï¼‰ï¼Œå†æ‰¾å®ƒçš„ä½ç½®ï¼Œå½“ç„¶è¿˜éœ€ç”¨ä¸€ä¸ªå˜é‡è®°å½•ä¸€ä¸‹ï¼Œé˜²æ­¢å¤šæ¬¡è§¦å‘å›è°ƒã€‚

```java
/**
 * è§¦å‘OnPageSelectedå›è°ƒ
 */
private fun triggerOnPageSelected() {
    val layoutManager = getLinearLayoutManager()
    val view = mSnapHelper.findSnapView(layoutManager)
    if (view != null) {
        val position = layoutManager.getPosition(view)
        //é˜²æ­¢åŒä¸€ä½ç½®å¤šæ¬¡è§¦å‘
        if (position != mOldPosition) {
            mOldPosition = position
            mPageChangeListener?.onPageSelected(position)
        }
    }
}
```

è¿˜æœ‰ä¸€ä¸ªå€¼å¾—è¯´é“çš„ç‚¹æ˜¯åˆå§‹åŒ–æ—¶éœ€è¦çŸ«æ­£**Snap**çš„ä½ç½®ï¼Œå› ä¸º**PagerSnapHelper**æ‰‹æŒ‡æ»‘åŠ¨çš„æ—¶å€™æ‰å·¥ä½œè®©RecyclerViewæ»‘åŠ¨å‡ºViewPagerçš„æ„Ÿè§‰ï¼Œæ‰€ä»¥åˆå§‹åŒ–æ—¶ä¸çŸ«æ­£ä¼šå‘ç°é€‰ä¸­çš„é¡µé¢ä¸å±…ä¸­æ˜¾ç¤ºï¼Œè¿˜æ˜¯ä¸€ä¸ªRecyclerViewçš„æ ·å­ã€‚é‚£å¦‚ä½•çŸ«æ­£å‘¢ï¼Ÿè¿™é‡Œå»çœ‹äº†**PagerSnapHelper**å®ç°ï¼Œæ¬è¿‡æ¥ï¼Œç¨åŠ ä¿®æ”¹å³å¯ã€‚

```java
/**
 * çŸ«æ­£é¦–æ¬¡åˆå§‹åŒ–æ—¶SnapViewçš„ä½ç½®
 */
private fun correctSnapViewPosition() {
    val layoutManager = getLinearLayoutManager()
    val snapView = mSnapHelper.findSnapView(layoutManager)
    if (snapView != null) {
        val snapDistance = mSnapHelper.calculateDistanceToFinalSnap(layoutManager, snapView)
        if (snapDistance != null) {
            if (snapDistance[0] != 0 || snapDistance[1] != 0) {
                //æˆ‘ä»¬æŠŠæºç çš„smoothScrollByæ”¹ä¸ºscrollByï¼Œè¿™æ ·è§†è§‰ä¸Šè§‰å¯Ÿä¸å‡ºçŸ«æ­£è¿‡ç¨‹
                scrollBy(snapDistance[0], snapDistance[1])
            }
            //é¦–æ¬¡è§¦å‘å›è°ƒ
            triggerOnPageSelected()
        }
    }
}

/**
 * è¿™æ˜¯æºç 
 */
void snapToTargetExistingView() {
    if (this.mRecyclerView != null) {
        LayoutManager layoutManager = this.mRecyclerView.getLayoutManager();
        if (layoutManager != null) {
            View snapView = this.findSnapView(layoutManager);
            if (snapView != null) {
                int[] snapDistance = this.calculateDistanceToFinalSnap(layoutManager, snapView);
                if (snapDistance[0] != 0 || snapDistance[1] != 0) {
                    this.mRecyclerView.smoothScrollBy(snapDistance[0], snapDistance[1]);
                }
            }
        }
    }
}
```

ä»¥ä¸Šæ˜¯æˆ‘è®¤ä¸ºPagerRecyclerViewè¾ƒä¸ºå…³é”®çš„ç‚¹ï¼Œå…¶å®ƒéƒ¨åˆ†å‡ä¸ºä¸šåŠ¡é€»è¾‘çš„å¤„ç†ä¸å®ç°ï¼Œå¤§å®¶å¯æ‰“å¼€æºç è‡ªè¡Œé£Ÿç”¨ã€‚

##  PagerViewFactory

è¿™é‡Œé‡‡ç”¨äº†**å·¥å‚æ–¹æ³•æ¨¡å¼**æ¥åˆ›å»ºBanneråº•å±‚çš„æ ¸å¿ƒå®ç°ã€‚

é¦–å…ˆå®šä¹‰äº†BannerViewå®ä¾‹æ¥å£ï¼Œå®ƒå°†ä½œä¸ºå·¥å‚å®ä¾‹çš„æ„é€ æ–¹æ³•å‚æ•°ï¼Œç”¨äºåŒºåˆ†åˆ›å»ºåº•å±‚å®ç°ã€‚

```java
interface IBannerViewBase {
    fun getCount(): Int

    fun getItemView(context: Context): View

    fun onBindView(itemView: View, position: Int)
}

/**
 * å®šä¹‰BannerViewå®ä¾‹æ¥å£
 */
interface IBannerViewInstance : IBannerViewBase {

    fun getContext(): Context

    fun isSmoothMode(): Boolean

    fun getItemViewWidth(): Int

    fun getItemViewMargin(): Int

    fun getItemViewAlign(): Int
}
```

å·¥å‚æœ‰ä¸ªgetPagerView()çš„æ–¹æ³•ï¼Œæ¥åˆ›å»ºBanneræ ¸å¿ƒå®ç°

```java
/**
 * å·¥å‚æ ¹æ®å‚æ•°åˆ›å»ºå¯¹åº”PagerViewå®ä¾‹
 */
override fun getPagerView(): IPagerViewInstance {
    return if (bannerView.isSmoothMode()) {
        casePagerRecycler(true)
    } else {
        if (intervalUseViewPager) {
            //è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦ç”¨ViewPageråšåº•å±‚å®ç°
            throw IllegalStateException("è¿™é‡Œæœªä½¿ç”¨ViewPageråšåº•å±‚å®ç°")
        } else {
            casePagerRecycler(false)
        }
    }
}
```

è¿™é‡Œå°±æ˜¯åˆ›å»ºäº†ä¹‹å‰å†™å¥½çš„PagerRecyclerViewï¼Œå…¶å®å°±æ˜¯åˆ›å»ºé…ç½®ä½¿ç”¨ä¸€ä¸ªRecyclerViewçš„è¿‡ç¨‹ã€‚

```java
/**
 * å¤„ç†PagerRecyclerView
 */
private fun casePagerRecycler(isSmoothMode: Boolean): IPagerViewInstance {
    val recyclerView = PagerRecyclerView(bannerView.getContext())
    recyclerView.layoutManager = LinearLayoutManager(bannerView.getContext(), LinearLayoutManager.HORIZONTAL, false)
    recyclerView.adapter = object : RecyclerView.Adapter<RecyclerView.ViewHolder>() {
        override fun getItemCount(): Int {
            return Int.MAX_VALUE
        }

        override fun onBindViewHolder(holder: RecyclerView.ViewHolder, position: Int) {
            if (!isActivityDestroyed(holder.itemView.context)) {
                val realPos = position % bannerView.getCount()
                bannerView.onBindView(holder.itemView.findViewById(R.id.id_real_item_view), realPos)
            }
        }

        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): RecyclerView.ViewHolder {
            val itemWrapper = LayoutInflater.from(parent.context).inflate(
                R.layout.layout_banner_item_wrapper,
                parent,
                false
            ) as RelativeLayout

            //å¤„ç†ItemViewWrapperçš„å®½
            itemWrapper.layoutParams.width = bannerView.getItemViewWidth() + bannerView.getItemViewMargin()

            //å¤–éƒ¨å®é™…çš„ItemView
            val itemView = bannerView.getItemView(parent.context)
            itemView.id = R.id.id_real_item_view
            val ivParams = RelativeLayout.LayoutParams(
                bannerView.getItemViewWidth(),
                ViewGroup.LayoutParams.MATCH_PARENT
            )
            ivParams.addRule(bannerView.getItemViewAlign())

            //æ·»åŠ ItemViewåˆ°Wrapper
            itemWrapper.addView(itemView, ivParams)
            return object : RecyclerView.ViewHolder(itemWrapper) {}
        }
    }

    //åˆå§‹åŒ–ä½ç½®
    recyclerView.scrollToPosition(bannerView.getCount() * 100)
    recyclerView.setSmoothMode(isSmoothMode)

    return recyclerView
}
```

## Indicatorçš„è§£è€¦å®ç°

è§£è€¦çš„æƒ¯ç”¨å¥—è·¯å°±æ˜¯æŠ½è±¡æ–¹æ³•å®šä¹‰æ¥å£ã€‚æ‰€ä»¥æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªæ¥å£ï¼Œä¸€ä¸ªæ˜¯**æŒ‡ç¤ºå™¨å®ä¾‹éœ€å®ç°çš„æ¥å£**ï¼Œä¸€ä¸ªæ˜¯**æŒ‡ç¤ºå™¨ä¾èµ–çš„å¤–éƒ¨å®ç°**ã€‚æ‰€ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªæ¥å£ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ç°æƒ³è¦çš„æ ·å¼ã€‚

```java
/**
 * æŒ‡ç¤ºå™¨å®ä¾‹éœ€å®ç°çš„æ¥å£
 */
interface IIndicatorInstance {

    /**
     * è®¾ç½®å¤–éƒ¨å®ç°
     */
    fun setIndicator(impl: IIndicator)

    /**
     * é‡æ–°å¸ƒå±€
     */
    fun doRequestLayout()

    /**
     * é‡æ–°ç»˜åˆ¶
     */
    fun doInvalidate()

}

/**
 * æŒ‡ç¤ºå™¨ä¾èµ–çš„å¤–éƒ¨å®ç°
 */
interface IIndicator {

    /**
     * è·å–adapteræ€»æ•°ç›®
     */
    fun getCount(): Int

    /**
     * è·å–å½“å‰é€‰ä¸­é¡µé¢çš„ç´¢å¼•
     */
    fun getCurrentIndex(): Int

}
```

å¯¹äºæˆ‘ä»¬è¿™æ¬¡å®ç°çš„CrossBarIndicatorï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå¸¸è§„çš„è‡ªå®šä¹‰Viewï¼Œè¿™é‡Œå·²æ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„å•¦ã€‚é‡ç‚¹è¦è¯´çš„æ˜¯éœ€æ±‚ä¸­æœ‰**ä¸€æ¡ä¸”èƒ½çµæ´»æ§åˆ¶æŒ‡ç¤ºå™¨ä½ç½®**ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿéœ€æ±‚åˆ†ææ—¶è¯´äº†ï¼Œæˆ‘ä»¬çš„BannerViewæ˜¯ä¸€ä¸ªRelativeLayoutï¼ŒIndicatorä½œä¸ºå…¶å­Viewå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ§åˆ¶å…¶ä½ç½®ã€‚

ç„¶åï¼Œçœ‹ä¸‹BannerViewä¸­çš„å…³é”®ä»£ç ï¼š

```java
override fun onFinishInflate() {
    super.onFinishInflate()
    findIndicator()
}

/**
 * åœ¨å­Viewä¸­æ‰¾åˆ°æŒ‡ç¤ºå™¨
 */
private fun findIndicator() {
    for (i in 0 until childCount) {
        val child = getChildAt(i)
        if (child is IIndicatorInstance) {
            //å¸ƒå±€å¡«å……å®Œæ¯•æ—¶ï¼Œæ‰¾åˆ°å­Viewä¸­çš„Indicatorï¼Œå¹¶ä¿å­˜ä¸‹æ¥
            mIndicator = child
            return
        }
    }
}

/**
 * åˆå§‹åŒ–view
 */
private fun initView() {
    if (mBannerViewImpl != null && mWidth > 0) {
        val bvImpl = mBannerViewImpl!!
        removeAllViews()

        ... çœç•¥ä»£ç 

        //åˆå§‹åŒ–æŒ‡ç¤ºå™¨
        if (mIndicator != null) {
            mIndicator?.setIndicator(object : IIndicator {

                override fun getCount(): Int {
                    return bvImpl.getCount()
                }

                override fun getCurrentIndex(): Int {
                    return mPagerViewInstance.getRealCurrentPosition(bvImpl.getCount())
                }

            })
            //æŠŠæŒ‡ç¤ºå™¨å†æ·»åŠ å›å»
            addView(mIndicator as View)
        }
    }
}
```

## æ–‡æœ«

åˆ°è¿™é‡Œæ•´ä½“è¦è¯´çš„å°±å®Œç»“äº†ï¼Œæ•´ä¸ªBannerViewçš„å®ç°ç»†èŠ‚ã€é€»è¾‘è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œä¸è¿‡å¤æ‚åº¦å€’æ²¡é‚£ä¹ˆé«˜ï¼Œå»ºè®®é£Ÿç”¨æºç ~ O(âˆ©_âˆ©)Oå“ˆå“ˆ~

**ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œå¦‚æœ‰ä¸æ­£ä¹‹å¤„æ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡å‡ºï¼Œæˆ‘ä¼šè™šå¿ƒæ¥å—å¹¶ç¬¬ä¸€æ—¶é—´ä¿®æ”¹ï¼Œä»¥ä¸è¯¯å¯¼å¤§å®¶ã€‚**

## **æ‹œè¯»çš„æ–‡ç« **

SnapHelperç¡¬æ ¸è®²è§£ï¼š

> https://juejin.im/post/5cbe78ae5188250a6b183872