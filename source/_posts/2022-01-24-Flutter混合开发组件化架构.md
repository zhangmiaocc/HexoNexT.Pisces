---
title: Flutteræ··åˆå¼€å‘ç»„ä»¶åŒ–æ¶æ„
tags:
  - Android
  - Flutter
categories:
  - Android
  - Flutter
abbrlink: 187f2070
date: 2022-01-24 15:39:53
---

- **èƒŒæ™¯**
- **Flutterçš„å››ç§å·¥ç¨‹ç±»å‹**
- **Flutterå·¥ç¨‹Pubä¾èµ–ç®¡ç†**
- **FlutterModuleé›†æˆåˆ°Native**
- **Flutterä¸Nativeé€šä¿¡**
- **Flutterç»„ä»¶åŒ–å·¥ç¨‹**
- **ååº**

## ä¸€ã€èƒŒæ™¯
Flutter åœ¨ç›®å‰è·¨å¹³å°æ–¹æ¡ˆä¸­æœ‰æ›´å¥½çš„å¹³å°ä¸€è‡´æ€§ä»¥åŠæ›´ä¼˜çš„ä½“éªŒã€‚ä½†å¯¹äºæœ¬èº«å·²æœ‰æˆç†Ÿçš„ä¸šåŠ¡ä»£ç çš„é¡¹ç›®æ¥è¯´ï¼Œæ›´å¤šçš„æ˜¯é‡‡ç”¨æ··åˆæ ˆçš„æ–¹å¼ï¼Œåœ¨ä¸å˜æ›´åŸæœ‰ App ä¸šåŠ¡çš„åŸºç¡€ä¸Šï¼Œå°† Flutter èƒ½åŠ›æ‰©å±•ä¸ºå­æ¨¡å—è¿›è¡Œæ¥å…¥å’Œå¼€å‘ã€‚è¿™æ ·å¹¶ä¸å½±å“åŸæœ‰çš„ä¸šåŠ¡å’ŒåŸç”Ÿèƒ½åŠ›ï¼Œåˆå¯ä»¥ç»“åˆä¸šåŠ¡éœ€æ±‚è¿›è¡ŒæŠ€æœ¯é€‰æ‹©ã€‚

## äºŒã€Flutter çš„å››ç§å·¥ç¨‹ç±»å‹
### 2.1. Flutter Application
æ ‡å‡†çš„Flutter Appå·¥ç¨‹ï¼ŒåŒ…å«æ ‡å‡†çš„Dartå±‚ä¸Nativeå¹³å°å±‚
### 2.2. Flutter Module
Flutterç»„ä»¶å·¥ç¨‹ï¼Œä»…åŒ…å«Dartå±‚å®ç°ï¼ŒNativeå¹³å°å±‚å­å·¥ç¨‹ä¸ºé€šè¿‡Flutterè‡ªåŠ¨ç”Ÿæˆçš„éšè—å·¥ç¨‹
### 2.3. Flutter Plugin
Flutterå¹³å°æ’ä»¶å·¥ç¨‹ï¼ŒåŒ…å«Dartå±‚ä¸Nativeå¹³å°å±‚çš„å®ç°
### 2.4. Flutter Package
Flutterçº¯Dartæ’ä»¶å·¥ç¨‹ï¼Œä»…åŒ…å«Dartå±‚çš„å®ç°ï¼Œå¾€å¾€å®šä¹‰ä¸€äº›å…¬å…±Widget

<!--more-->

## ä¸‰ã€Flutterå·¥ç¨‹Pubä¾èµ–ç®¡ç†
Flutterå·¥ç¨‹ä¹‹é—´çš„ä¾èµ–ç®¡ç†æ˜¯é€šè¿‡Pubæ¥ç®¡ç†çš„ï¼Œä¾èµ–çš„äº§ç‰©æ˜¯ç›´æ¥æºç ä¾èµ–ï¼Œè¿™ç§ä¾èµ–æ–¹å¼å’ŒIOSä¸­çš„Podæœ‰ç‚¹åƒï¼Œéƒ½å¯ä»¥è¿›è¡Œä¾èµ–åº“ç‰ˆæœ¬å·çš„åŒºé—´é™å®šä¸Gitè¿œç¨‹ä¾èµ–ç­‰ï¼Œå…¶ä¸­å…·ä½“å£°æ˜ä¾èµ–æ˜¯åœ¨**pubspec.yaml**æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­çš„ä¾èµ–ç¼–å†™æ˜¯åŸºäºYAMLè¯­æ³•ï¼ŒYAMLæ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥ç¼–å†™æ–‡ä»¶é…ç½®çš„è¯­è¨€ã€‚

å£°æ˜ä¾èµ–åï¼Œé€šè¿‡è¿è¡Œ**flutter packages get**å‘½åï¼Œä¼šä»è¿œç¨‹æˆ–æœ¬åœ°æ‹‰å–å¯¹åº”çš„ä¾èµ–ï¼ŒåŒæ—¶ä¼šç”Ÿæˆpubspec.lockæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å’ŒIOSä¸­çš„Podfile.lockæå…¶ç›¸ä¼¼ï¼Œä¼šåœ¨æœ¬åœ°é”å®šå½“å‰ä¾èµ–çš„åº“ä»¥åŠå¯¹åº”ç‰ˆæœ¬å·ï¼Œåªæœ‰å½“æ‰§è¡Œ**flutter packages upgrade**æ—¶ï¼Œè¿™æ—¶æ‰ä¼šæ›´æ–°ã€‚

## å››ã€Flutter module é›†æˆåˆ° Native

ä¸Šè¿°è¯´çš„å¦‚æœæˆ‘ä»¬è¦åˆ©ç”¨Flutteræ¥å¼€å‘æˆ‘ä»¬ç°æœ‰Nativeå·¥ç¨‹ä¸­çš„ä¸€ä¸ªæ¨¡å—æˆ–åŠŸèƒ½ï¼Œè‚¯å®šå¾—ä¸èƒ½æ”¹å˜Nativeçš„å·¥ç¨‹ç»“æ„ä»¥åŠä¸å½±å“ç°æœ‰çš„å¼€å‘æµç¨‹ï¼Œé‚£ä¹ˆï¼Œä»¥ä½•ç§æ–¹å¼è¿›è¡Œæ··åˆå¼€å‘å‘¢ï¼Ÿ

### 4.1 Flutteræ··åˆå¼€å‘æ¨¡å¼

Flutteræ··åˆå¼€å‘æ¨¡å¼ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š

- Flutter App æˆ‘ä»¬å¯ä»¥ç›´æ¥å¿½ç•¥ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªå¼€å‘å…¨æ–°çš„Flutter Appå·¥ç¨‹ã€‚
- å¯¹äºFlutter Moduleï¼Œå®˜æ–¹æä¾›çš„æœ¬åœ°ä¾èµ–ä¾¿æ˜¯ä½¿ç”¨Flutter Moduleä¾èµ–åˆ°Native Appçš„ï¼Œè€Œå¯¹äºFlutterå·¥ç¨‹æ¥è¯´ï¼Œæ„å»ºFlutterå·¥ç¨‹å¿…é¡»å¾—æœ‰ä¸ªmain.dartä¸»å…¥å£ï¼Œæ°å¥½Flutter Moduleä¸­ä¹Ÿæœ‰ä¸»å…¥å£ã€‚

### 4.2 Flutter Moduleçš„åˆ›å»ºæ–¹å¼

Flutter moduleåˆ›å»ºæ–¹å¼ä¸€èˆ¬æœ‰ä¸¤ç§ï¼š

**aã€é€šè¿‡å‘½ä»¤æ¥åˆ›å»º**

> flutter create -t module --org com.vhall.module vhall_flutter_module

```
Creating project vhall_flutter_module...
  vhall_flutter_module/test/widget_test.dart (created)
  vhall_flutter_module/vhall_flutter_module.iml (created)
  vhall_flutter_module/.gitignore (created)
  vhall_flutter_module/.metadata (created)
  vhall_flutter_module/pubspec.yaml (created)
  vhall_flutter_module/README.md (created)
  vhall_flutter_module/lib/main.dart (created)
  vhall_flutter_module/vhall_flutter_module_android.iml (created)
  vhall_flutter_module/analysis_options.yaml (created)
  vhall_flutter_module/.idea/libraries/Dart_SDK.xml (created)
  vhall_flutter_module/.idea/modules.xml (created)
  vhall_flutter_module/.idea/workspace.xml (created)
Running "flutter pub get" in vhall_flutter_module...             1,226ms
Wrote 12 files.

All done!
Your module code is in vhall_flutter_module/lib/main.dart.
```

**bã€ä½¿ç”¨ As åˆ›å»º Flutter Module**

åœ¨ As ä¸­é€‰æ‹© File->New->New Flutter Projectï¼Œé€‰æ‹© Flutter Module åˆ›å»º Flutter Module å­é¡¹ç›®

### 4.3 æ·»åŠ Flutterçš„ä¸¤ç§ä¾èµ–æ–¹å¼

#### 4.3.1 å°†Flutteræ·»åŠ åˆ°åŸç”Ÿå·¥ç¨‹ä¸­ï¼Œ æœ‰ä¸¤ç§æ–¹å¼ï¼š

**aã€ä»¥aarçš„æ–¹å¼é›†æˆåˆ°ç°æœ‰Androidé¡¹ç›®ä¸­**

åˆ›å»ºå¥½ Flutter Module ä¹‹åéœ€è¦å°†å…¶ç¼–è¯‘æˆ aar çš„å½¢å¼ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œ aar çš„ç¼–è¯‘ï¼š

> cd vhall_flutter_module flutter build aar              

åœ¨ Android ä¸­ä¹Ÿå¯ä»¥é€šè¿‡ As å·¥å…·æ¥ç¼–è¯‘ aarï¼Œé€‰æ‹© Build->Flutter->Build AAR æ¥è¿›è¡Œ aar çš„ç¼–è¯‘ã€‚

ç„¶åæ ¹æ®æç¤ºåœ¨ä¸»é¡¹ç›®å·¥ç¨‹çš„ build.grade æ–‡ä»¶ä¸­è¿›è¡Œç›¸å…³é…ç½®ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š

```

ğŸ’ª Building with sound null safety ğŸ’ª

Running Gradle task 'assembleAarDebug'...                          22.2s
âœ“ Built build/host/outputs/repo.
Running Gradle task 'assembleAarProfile'...                        46.1s
âœ“ Built build/host/outputs/repo.
Running Gradle task 'assembleAarRelease'...                        37.2s
âœ“ Built build/host/outputs/repo.

Consuming the Module
  1. Open <host>/app/build.gradle
  2. Ensure you have the repositories configured, otherwise add them:

      String storageUrl = System.env.FLUTTER_STORAGE_BASE_URL ?: "https://storage.googleapis.com"
      repositories {
        maven {
            url '/Users/zhangmiao/Documents/project/hybrid/vhall_flutter_module/build/host/outputs/repo'
        }
        maven {
            url "$storageUrl/download.flutter.io"
        }
      }

  3. Make the host app depend on the Flutter module:

    dependencies {
      debugImplementation 'com.vhall.module.vhall_flutter_module:flutter_debug:1.0'
      profileImplementation 'com.vhall.module.vhall_flutter_module:flutter_profile:1.0'
      releaseImplementation 'com.vhall.module.vhall_flutter_module:flutter_release:1.0'
    }


  4. Add the `profile` build type:

    android {
      buildTypes {
        profile {
          initWith debug
        }
      }
    }

To learn more, visit https://flutter.dev/go/build-aar
```
ä¼˜ç‚¹ï¼š

- ä¾èµ–ä¸€ä¸ªåŒ…å« Flutter äº§ç‰©çš„ aar åŒ…ï¼Œè¿™ä¸ªçš„å¥½å¤„å°±æ˜¯å…¶ä»–ä¸å¼€å‘ flutter çš„åŒå­¦å¯ä»¥ä¸ç”¨é…ç½® flutter ç¯å¢ƒï¼Œå®ƒå’Œå…¶ä»–æ¨¡å—åŒ…æ— å¼‚

**bã€ä»¥ Flutet module çš„æ–¹å¼é›†æˆåˆ°ç°æœ‰ Android é¡¹ç›®ä¸­**

åœ¨ setting.gradle æ–‡ä»¶ä¸­é…ç½® flutter module å¦‚ä¸‹ï¼š
```
setBinding(new Binding([gradle: this]))
evaluate(new File(
  settingsDir,
  '../vhall_flutter_module/.android/include_flutter.groovy'
))
```

åœ¨ app é¡¹ç›®çš„ build.gradle ä¾èµ– flutter module æ¨¡å—

```
dependencies {
  implementation project(':flutter')
}
```

ç¼ºç‚¹ï¼š

- éœ€è¦ flutter ç¯å¢ƒï¼Œå¹¶ä¸”å„ä¸ªå¼€å‘äººå‘˜ç¯å¢ƒä¸ä¸€è‡´ï¼Œå¯¼è‡´é›†æˆå› ä¸ºç‰ˆæœ¬ä¸ä¸€è‡´æŠ¥å„ç§é”™è¯¯

### 4.3.2æœ¬åœ°ä¾èµ–çš„åŸç†

**Android**

åœ¨Androidä¸­æœ¬åœ°ä¾èµ–æ–¹å¼ä¸ºï¼š

- åœ¨**settings.gradle**ä¸­æ³¨å…¥**include_flutter.groovy**è„šæœ¬
- åœ¨éœ€è¦ä¾èµ–çš„appä¸­**build.gradle**æ·»åŠ **project(':flutter')**ä¾èµ–

å¯¹äºAndroidçš„æœ¬åœ°ä¾èµ–ï¼Œä¸»è¦æ˜¯ç”±**include_flutter.groovy**å’Œ**flutter.gradle**è¿™ä¸¤ä¸ªè„šæœ¬è´Ÿè´£Flutterçš„æœ¬åœ°ä¾èµ–å’Œäº§ç‰©æ„å»ºã€‚

**a**ã€**include_flutter.groovy**

åœ¨**settings.gradle**ä¸­æ³¨å…¥æ—¶ï¼Œåˆ†åˆ«ç»‘å®šäº†å½“å‰æ‰§è¡ŒGradleçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸æ‰§è¡Œ**include_flutter.groovy**è„šæœ¬ï¼Œè¯¥è„šæœ¬åªåšäº†ä¸‹é¢ä¸‰ä»¶äº‹ï¼š

- include FlutterModuleä¸­çš„**.android/Flutter**å·¥ç¨‹
- include FlutterModuleä¸­çš„**.flutter-plugins**æ–‡ä»¶ä¸­åŒ…å«çš„Flutterå·¥ç¨‹è·¯å¾„ä¸‹çš„android module
- é…ç½®æ‰€æœ‰å·¥ç¨‹çš„**build.gradle**é…ç½®æ‰§è¡Œé˜¶æ®µéƒ½ä¾èµ–äº**:flutter**å·¥ç¨‹ï¼Œä¹Ÿå³å®ƒæœ€å…ˆæ‰§è¡Œé…ç½®é˜¶æ®µ

å…¶ä¸­**.flutter-plugins**æ–‡ä»¶ï¼Œæ˜¯æ ¹æ®å½“å‰ä¾èµ–è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œé‡Œé¢åŒ…å«äº†å½“å‰Flutterå·¥ç¨‹æ‰€ä¾èµ–ï¼ˆç›´æ¥ä¾èµ–å’Œä¼ é€’ä¾èµ–ï¼‰çš„Flutterå­å·¥ç¨‹ä¸ç»å¯¹è·¯å¾„çš„K-Vå…³ç³»ï¼Œå­å·¥ç¨‹å¯èƒ½æ˜¯ä¸€ä¸ªFlutter Pluginæˆ–è€…æ˜¯ä¸€ä¸ªFlutter Packageã€‚

 **b**ã€**flutter.gradle**

è¯¥è„šæœ¬ä½äºFlutter SDKä¸­ï¼Œå†…å®¹çœ‹èµ·æ¥å¾ˆé•¿ï¼Œå…¶å®ä¸»è¦åšäº†ä¸‹é¢ä¸‰ä»¶äº‹ï¼š

- é€‰æ‹©ç¬¦åˆå¯¹åº”æ¶æ„çš„Flutterå¼•æ“ï¼ˆflutter.soï¼‰
- è§£æä¸Šè¿°**.flutter-plugins**æ–‡ä»¶ï¼ŒæŠŠå¯¹åº”çš„android moduleæ·»åŠ åˆ°Nativeå·¥ç¨‹çš„ä¾èµ–ä¸­ï¼ˆä¸Šè¿°çš„includeå…¶å®ä¸ºè¿™æ­¥åšå‡†å¤‡ï¼‰
- Hook mergeAssets/processResources Taskï¼Œé¢„å…ˆæ‰§è¡ŒFlutterTaskï¼Œè°ƒç”¨**flutter**å‘½ä»¤ç¼–è¯‘Dartå±‚ä»£ç æ„å»ºå‡º**flutter_assets**äº§ç‰©ï¼Œå¹¶æ‹·è´åˆ°**assets**ç›®å½•ä¸‹

æœ‰äº†ä¸Šè¿°ä¸‰æ­¥ï¼Œåˆ™ç›´æ¥åœ¨Nativeå·¥ç¨‹ä¸­è¿è¡Œæ„å»ºå³å¯è‡ªåŠ¨æ„å»ºFlutterå·¥ç¨‹ä¸­çš„ä»£ç å¹¶è‡ªåŠ¨æ‹·è´äº§ç‰©åˆ°Nativeä¸­

**IOS**

åœ¨IOSä¸­æœ¬åœ°ä¾èµ–æ–¹å¼ä¸ºï¼š

- åœ¨Podfileä¸­é€šè¿‡**eval binding**ç‰¹æ€§æ³¨å…¥**podhelper.rb**è„šæœ¬ï¼Œåœ¨pod install/updateæ—¶ä¼šæ‰§è¡Œå®ƒ
- åœ¨IOSæ„å»ºé˜¶æ®µ**Build Phases**ä¸­æ³¨å…¥æ„å»ºæ—¶éœ€è¦æ‰§è¡Œçš„**xcode_backend.sh**è„šæœ¬

å¯¹äºIOSçš„æœ¬åœ°ä¾èµ–ï¼Œä¸»è¦æ˜¯ç”±**podhelper.rb**å’Œ**xcode_backend.sh**è¿™ä¸¤ä¸ªè„šæœ¬è´Ÿè´£Flutterçš„Podæœ¬åœ°ä¾èµ–å’Œäº§ç‰©æ„å»º

**a**ã€**podhelper.rb**

å› Podfileæ˜¯é€šè¿‡rubyè¯­è¨€å†™çš„ï¼Œæ‰€ä»¥è¯¥è„šæœ¬ä¹Ÿæ˜¯rubyè„šæœ¬ï¼Œè¯¥è„šæœ¬åœ¨pod install/updateæ—¶ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š

- Podæœ¬åœ°ä¾èµ–Flutterå¼•æ“ï¼ˆFlutter.frameworkï¼‰ä¸Flutteræ’ä»¶æ³¨å†Œè¡¨ï¼ˆFlutterPluginRegistrantï¼‰
- Podæœ¬åœ°æºç ä¾èµ–**.flutter-plugins**æ–‡ä»¶ä¸­åŒ…å«çš„Flutterå·¥ç¨‹è·¯å¾„ä¸‹çš„ioså·¥ç¨‹
- åœ¨pod installæ‰§è¡Œå®Œå**post_install**ä¸­ï¼Œè·å–å½“å‰targetå·¥ç¨‹å¯¹è±¡ï¼Œå¯¼å…¥**Generated.xcconfig**é…ç½®ï¼Œè¿™äº›é…ç½®éƒ½ä¸ºç¯å¢ƒå˜é‡é…ç½®ï¼Œä¸»è¦ä¸ºæ„å»ºé˜¶æ®µ**xcode_backend.sh**è„šæœ¬æ‰§è¡Œåšå‡†å¤‡

ä¸Šè¿°äº‹æƒ…å³å¯ä¿è¯Flutterå·¥ç¨‹ä»¥åŠä¼ é€’ä¾èµ–çš„éƒ½é€šè¿‡podæœ¬åœ°ä¾èµ–è¿›Nativeå·¥ç¨‹äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ„å»ºäº†

**bã€xcode_backend.sh**

è¯¥Shellè„šæœ¬ä½äºFlutter SDKä¸­ï¼Œè¯¥è„šæœ¬ä¸»è¦å°±åšäº†ä¸¤ä»¶äº‹ï¼š

- è°ƒç”¨flutterå‘½ä»¤ç¼–è¯‘æ„å»ºå‡ºäº§ç‰©ï¼ˆApp.frameworkã€flutter_assetsï¼‰
- æŠŠäº§ç‰©ï¼ˆ*.frameworkã€flutter_assetsï¼‰æ‹·è´åˆ°å¯¹åº”XCodeæ„å»ºäº§ç‰©ä¸­ï¼Œå¯¹åº”äº§ç‰©ç›®å½•ä¸ºï¼š**$HOME/Library/Developer/Xcode/DerivedData/${AppName}**

ä¸Šè¿°ä¸¤ä¸ªé™æ€åº“***.framework**æ˜¯æ‹·è´åˆ°**${BUILT_PRODUCTS_DIR}"/"${PRODUCT_NAME}".app/Frameworks"**ç›®å½•ä¸‹

flutter_assetsæ‹·è´åˆ°**${BUILT_PRODUCTS_DIR}"/"${PRODUCT_NAME}".app"**ç›®å½•ä¸‹

åœ¨XCodeå·¥ç¨‹ä¸­ï¼Œå¯¹åº”çš„æ˜¯åœ¨**${AppName}/Products/${AppName}.app**

### 4.4 åŸç”Ÿæ¥å…¥ flutter é¡µé¢

flutter ä¾èµ–æä¾›äº† FlutterActivity æ¥ç›´æ¥åŠ è½½ flutter é¡µé¢ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ¸…å•æ–‡ä»¶ä¸­é…ç½®è¯¥ Activity ï¼š

ï¼ˆé€šå¸¸æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª Activity ç»§æ‰¿ FlutterActivityï¼‰
```
<activity
    android:name="io.flutter.embedding.android.FlutterActivity"
    android:theme="@style/Theme.Vhall_app"
    android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
    android:hardwareAccelerated="true"
    android:windowSoftInputMode="adjustResize"/>
```

ä¸‰ç§æ‰“å¼€flutteré¡µé¢çš„æ–¹å¼ï¼š

1ï¼‰æ™®é€šè·³è½¬ï¼š
```
myButton.setOnClickListener(new View.OnClickListener() {
  @Override
  public void onClick(View v) {
    startActivity(
      FlutterActivity.createDefaultIntent(currentActivity)
    );
  }
});
```

2ï¼‰è®¾ç½®è·¯ç”±çš„æ–¹å¼è·³è½¬ï¼š
```
myButton.setOnClickListener(new View.OnClickListener() {
  @Override
  public void onClick(View v) {
    startActivity(
      FlutterActivity
        .withNewEngine()
        .initialRoute("/my_route")
        .build(currentActivity)
      );
  }
});
```
ä¸Šè¿°ä»£ç ä¼šåœ¨å†…éƒ¨åˆ›å»ºè‡ªå·±çš„ FlutterEngine å®ä¾‹ï¼Œæ¯ä¸ª FlutterActivity éƒ½åˆ›å»ºè‡ªå·±çš„ FlutterEngineï¼Œè¿™æ„å‘³ç€å¯åŠ¨ä¸€ä¸ªæ ‡å‡†çš„ FlutterActivity ä¼šåœ¨ç•Œé¢å¯è§æ—¶å‡ºç°ä¸€çŸ­æš‚çš„å»¶è¿Ÿï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨é¢„ç¼“å­˜çš„ FlutterEngine æ¥å‡å°å…¶å»¶è¿Ÿï¼Œå®é™…ä¸Šåœ¨å†…éƒ¨ä¼šå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨é¢„ç¼“å­˜çš„ FlutterEngineï¼Œå¦‚æœå­˜åœ¨åˆ™ä½¿ç”¨è¯¥ FlutterEngineï¼Œå¦åˆ™ç»§ç»­ä½¿ç”¨éé¢„ç¼“å­˜çš„ FlutterEngineã€‚

3ï¼‰ç¼“å­˜ Flutter å¼•æ“æ–¹å¼è·³è½¬ï¼š
```
public class MyApplication extends Application {
    public FlutterEngine flutterEngine;

    @Override
Â  public void onCreate() {
        super.onCreate();
        // Instantiate a FlutterEngine.
    Â    flutterEngine = new FlutterEngine(this);

       // Start executing Dart code to pre-warm the FlutterEngine.
    Â   flutterEngine.getDartExecutor().executeDartEntrypoint(DartExecutor.DartEntrypoint.createDefault());

       // Cache the FlutterEngine to be used by FlutterActivity.
    Â   FlutterEngineCache.getInstance().put("my_engine_id", flutterEngine);
    }
}

myButton.setOnClickListener(new View.OnClickListener() {
    @Override
Â    public void onClick(View view) {
        startActivity(
            LoginFlutterActivity
                Â  .withCachedEngine("my_engine_id")
                  .build(MainActivity.this)
        );
Â   }
});
```

## äº”ã€Flutterä¸Nativeé€šä¿¡

### 5.1Platform Channel

**Platform Channel**ä¸ºDartå’Œå¹³å°ä¹‹é—´æä¾›äº†ç›¸äº’é€šä¿¡çš„æœºåˆ¶ï¼Œå°†**Flutter**ã€**Android**ã€**iOS**è¿æ¥èµ·æ¥ã€‚

åœ¨ç§»åŠ¨H5å¼€å‘ä¸­ï¼Œ**webview**è‡ªèº«æä¾›çš„åŠŸèƒ½å¾€å¾€ä¸å¤Ÿç”¨ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†**jsbridge**ï¼Œå³**web**ä¸**native**ä¹‹é—´è¿›è¡Œæ•°æ®äº¤äº’çš„ä¸€ç§æ–¹æ³•,å¯ä»¥æ–¹ä¾¿çš„å°†nativeçš„åŠŸèƒ½æ‰©å±•ç»™**webview**ä½¿ç”¨ï¼Œä»è€Œå¯ä»¥å¿«é€Ÿå¼€å‘ã€‚åœ¨**Flutter**ä¸­ï¼Œä¹Ÿå­˜åœ¨å’Œ**jsbridge**ä¸€æ ·çš„ç”¨æ³•ï¼Œé‚£å°±æ˜¯**Platform Channel**ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡**Platform Channel**ï¼Œå°†**Flutter**å’Œ**Native**æ–¹ä¾¿çš„è¿æ¥åœ¨ä¸€èµ·ï¼Œæ¶æ„å›¾å¦‚ä¸‹:

![](https://raw.githubusercontent.com/zhangmiaocc/blogImageResource/master/img/20220124155717.png)

åœ¨Channelä¸­

1. clientå‘é€ä¿¡æ¯
2. hostæ¥å—ä¿¡æ¯å¹¶è¿”å›ç»“æœ
3. è€Œä¸”æ¶ˆæ¯å’Œå“åº”æ˜¯ä»¥å¼‚æ­¥æ–¹å¼ä¼ é€’çš„
4. Flutterå’ŒNatvieå¯ä»¥äº’ä¸ºclientå’Œhostï¼Œä¿¡æ¯ä¼ é€’æ˜¯åŒå‘çš„

### 5.2 ä¸‰ç§ä¸åŒç±»å‹çš„Platform Channel

Flutterå®šä¹‰äº†ä¸‰ç§ä¸åŒç±»å‹çš„Platform Channelç”¨äºFlutterä¸Host Appå¹³å°è¿›è¡Œé€šä¿¡ï¼Œå®ƒä»¬åˆ†åˆ«

- **BasicMessageChannel**ï¼šç”¨äºæ•°æ®ä¼ é€’ï¼Œå¯ä»¥åŒå‘çš„è¯·æ±‚æ•°æ®ã€‚
- **MethodChannel**ï¼šç”¨äºä¼ é€’æ–¹æ³•è°ƒç”¨ï¼Œå³Flutterç«¯å¯ä»¥è°ƒç”¨Platformç«¯çš„æ–¹æ³•å¹¶é€šè¿‡Resultæ¥å£å›è°ƒç»“æœæ•°æ®ã€‚
- **EventChannel**: ç”¨äºä¼ é€’äº‹ä»¶ï¼Œå³Flutterç«¯ç›‘å¬Platformç«¯çš„å®æ—¶æ¶ˆæ¯ï¼Œä¸€æ—¦Platformç«¯äº§ç”Ÿäº†æ•°æ®ï¼Œç«‹å³å›è°ƒåˆ°Flutterç«¯ã€‚

å…¶æ„é€ æ–¹æ³•éƒ½éœ€æŒ‡å®šä¸€ä¸ªé€šé“æ ‡è¯†ã€è§£ç¼–ç å™¨ä»¥åŠ BinaryMessengerï¼ŒBinaryMessenger æ˜¯ä¸€ä¸ª Flutter ä¸å¹³å°çš„é€šä¿¡å·¥å…·ï¼Œç”¨æ¥ä¼ é€’äºŒè¿›åˆ¶æ•°æ®ã€è®¾ç½®å¯¹åº”çš„æ¶ˆæ¯å¤„ç†å™¨ç­‰ã€‚

è§£ç¼–ç å™¨æœ‰ä¸¤ç§åˆ†åˆ«æ˜¯ MethodCodec å’Œ MessageCodecï¼Œå‰è€…å¯¹åº”æ–¹æ³•åè€…å¯¹åº”æ¶ˆæ¯ï¼ŒBasicMessageChannel ä½¿ç”¨çš„æ˜¯ MessageCodecï¼ŒMethodChannel å’Œ EventChannel ä½¿ç”¨çš„æ˜¯ MethodCodecã€‚

### 5.3 å¹³å°æ•°æ®ç±»å‹å¯¹ç…§

Platform Channel æä¾›ä¸åŒçš„æ¶ˆæ¯è§£ç æœºåˆ¶ï¼Œå¦‚ StandardMessageCodec æä¾›åŸºæœ¬æ•°æ®ç±»å‹çš„è§£ç¼–ç ã€JSONMessageCodec æ”¯æŒ Json çš„è§£ç¼–ç ç­‰ï¼Œåœ¨å¹³å°ä¹‹é—´é€šä¿¡æ—¶éƒ½ä¼šè‡ªåŠ¨è½¬æ¢ï¼Œå„å¹³å°æ•°æ®ç±»å‹å¯¹ç…§å¦‚ä¸‹ï¼š
![](https://raw.githubusercontent.com/zhangmiaocc/blogImageResource/master/img/20220124155756.png)

## å…­ã€Flutterç»„ä»¶åŒ–å·¥ç¨‹

### 6.1 èƒŒæ™¯

å‰é¢è®²äº†Flutterå’ŒNativeçš„æ··åˆå¼€å‘æ¨¡å¼ï¼ŒFlutterä½œä¸ºNativeå·¥ç¨‹çš„ä¸€ä¸ªModuleå­˜åœ¨ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆçš„å°†Flutterå’ŒNativeè¿›è¡Œç‰©ç†éš”ç¦»ï¼Œä½†éšç€Flutteræ‰¿è½½çš„ä¸šåŠ¡è¶Šæ¥è¶Šå¤šï¼Œä¸Nativeäº¤äº’çš„æ¥å£å˜çš„è¶Šæ¥è¶Šå¤šï¼Œå¸¦æ¥äº†å¾ˆå¤šç®¡ç†é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬è¿«åˆ‡éœ€è¦é‡‡ç”¨æ–°çš„å¼€å‘æ¨¡å¼ï¼Œå³Flutterçš„ç»„ä»¶åŒ–å¼€å‘æ–¹æ¡ˆã€‚

### 6.2 ç»„ä»¶åŒ–çš„ä¼˜åŠ¿

é‡‡ç”¨ç»„ä»¶åŒ–å¼€å‘Flutterï¼Œå°†ä¼šæœ‰å¦‚ä¸‹çš„ä¼˜åŠ¿ï¼š

- å°†åŠŸèƒ½æ¨¡å—åŒ–ï¼Œç›¸äº’ç‹¬ç«‹ï¼Œæ–¹ä¾¿ç®¡ç†
- æ¨¡å—ä¹‹é—´äº’ä¸å½±å“ï¼Œè€¦åˆä½ï¼Œä¸€äº›ä¸ä¸šåŠ¡æ— å…³çš„æ¨¡å—å¯ä»¥å¼€æºå‡ºæ¥ï¼Œä¾›å…¶ä»–APPä½¿ç”¨ï¼Œæä¾›ä»£ç çš„å¤ç”¨ã€‚
- é‡‡ç”¨ç»„ä»¶åŒ–å¼€å‘ï¼Œå¼€å‘æ—¶äº’ä¸å½±å“ï¼Œå¯ä»¥æé«˜å¼€å‘æ•ˆç‡ã€‚
- æ–¹ä¾¿å•å…ƒæµ‹è¯•

### 6.3 ç»„ä»¶åŒ–æ¶æ„

ç»„ä»¶åˆ’åˆ†ï¼Œé€šè¿‡Flutter Moduleä½œä¸ºæ‰€æœ‰é€šè¿‡Flutterå®ç°çš„æ¨¡å—æˆ–åŠŸèƒ½çš„èšåˆå…¥å£ï¼Œé€šè¿‡å®ƒè¿›è¡ŒFlutterå±‚åˆ°Nativeå±‚çš„åŒå‘å…³è”ã€‚è€ŒFlutterå¼€å‘ä»£ç å†™åœ¨å“ªé‡Œå‘¢ï¼Ÿå½“ç„¶å¯ä»¥ç›´æ¥å†™åœ¨Flutter Moduleä¸­ï¼Œè¿™æ²¡é—®é¢˜ï¼Œè€Œå¦‚æœåç»­å¼€å‘äº†å¤šä¸ªæ¨¡å—ã€ç»„ä»¶ï¼Œæˆ‘ä»¬çš„Dartä»£ç æ€»ä¸å¯èƒ½å…¨éƒ¨å†™åœ¨Flutter Moduleä¸­lib/å§ï¼Œå¦‚æœåœ¨lib/ç›®å½•ä¸‹å†å»ºç«‹å­ç›®å½•è¿›è¡Œæ¨¡å—åŒºåˆ†ï¼Œè¿™ä¸å¤±ä¸ºä¸€ç§æœ€ç®€å•çš„æ–¹å¼ï¼Œä¸è¿‡è¿™ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œæ‰€æœ‰æ¨¡å—å…±ç”¨ä¸€ä¸ªè¿œç¨‹Gitåœ°å€ï¼Œé¦–å…ˆåœ¨ç»„ä»¶å¼€å‘éš”ç¦»ä¸Šå®Œå…¨è€¦åˆäº†ï¼Œå…¶æ¬¡å„ä¸ªæ¨¡å—ç»„ä»¶æ²¡æœ‰å•ç‹¬çš„ç‰ˆæœ¬å·æˆ–Tagï¼Œä¸”åç»­æ¨¡å—ç»„ä»¶çš„å¢å¤šï¼Œå¸¦æ¥æ›´å¤šçš„æµ‹è¯•å›å½’æˆæœ¬ã€‚

æ­£ç¡®çš„ç»„ä»¶åŒ–æ–¹å¼ä¸ºä¸€ä¸ªç»„ä»¶æœ‰ä¸€ä¸ªç‹¬ç«‹çš„è¿œç¨‹Gitåœ°å€ç®¡ç†ï¼Œè¿™æ ·å„ä¸ªç»„ä»¶åœ¨å‘æ­£å¼ç‰ˆæ—¶éƒ½æœ‰ä¸€ä¸ªç‰ˆæœ¬å·å’ŒTagï¼Œä¸”åœ¨å„ä¸ªç»„ä»¶å¼€å‘ä¸Šå®Œå…¨éš”ç¦»ï¼Œåç»­ç»„ä»¶çš„å¢å¤šä¸å½±å“å…¶å®ƒç»„ä»¶ï¼ŒæŸä¸ªç»„ä»¶æ–°å¢éœ€æ±‚è€Œä¸éœ€å›å½’å…¶å®ƒç»„ä»¶ï¼Œå¸¦æ¥æ›´ä½çš„æµ‹è¯•æˆæœ¬ã€‚

å‰é¢æåˆ°Flutter Pluginå¯ä»¥æœ‰å¯¹åº”Dartå±‚ä»£ç ä¸å¹³å°å±‚çš„å®ç°ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·è®¾è®¡ï¼Œä¸€ä¸ªç»„ä»¶å¯¹åº”ä¸€ä¸ªFlutter Pluginï¼Œä¸€ä¸ªFlutter Pluginä¸ºä¸€ä¸ªå®Œæ•´çš„Flutterå·¥ç¨‹ï¼Œæœ‰ç‹¬ç«‹çš„Gitåœ°å€ï¼Œè€Œè¿™äº›ç»„ä»¶ä¹‹é—´ä¸èƒ½äº’ç›¸ä¾èµ–ï¼Œä¿æŒé›¶è€¦åˆï¼Œæ‰€ä»¥è¿™äº›ç»„ä»¶éƒ½åœ¨ä¸šåŠ¡å±‚ï¼Œå¯ä»¥å«åšä¸šåŠ¡ç»„ä»¶ï¼Œè¿™äº›ä¸šåŠ¡ç»„ä»¶ä¹‹é—´çš„é€šä¿¡å’Œå…¬å…±æœåŠ¡å¯ä»¥å†åˆ’åˆ†ä¸€å±‚åŸºç¡€å±‚ï¼Œå¯ä»¥å«åšåŸºç¡€ç»„ä»¶ï¼Œæ‰€æœ‰ä¸šåŠ¡ç»„ä»¶ä¾èµ–åŸºç¡€å±‚ï¼Œè€ŒFlutter Moduleä½œä¸ºèšåˆå±‚ä¾èµ–äºæ‰€æœ‰Flutterç»„ä»¶ï¼Œè¿™äº›Flutterå·¥ç¨‹ä¹‹é—´çš„ä¾èµ–æ­£æ˜¯é€šè¿‡Pubä¾èµ–è¿›è¡Œç®¡ç†çš„ã€‚

æ‰€ä»¥ï¼Œç»¼åˆä¸Šè¿°ï¼Œæ•´ä½“çš„ç»„ä»¶åŒ–æ¶æ„å¯ä»¥è®¾è®¡ä¸ºï¼š
![](https://raw.githubusercontent.com/zhangmiaocc/blogImageResource/master/img/20220124155848.png)

### 6.4ä¸šåŠ¡ç»„ä»¶ä¸åŸºç¡€ç»„ä»¶çš„å®šä½

å¯¹äºä¸Šé¢çš„åŸºç¡€ç»„ä»¶æ¯”å¦‚è¿˜å¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„åˆ’åˆ†ï¼Œä¸è¿‡ä¸å»ºè®®åˆ’åˆ†å¤ªå¤šï¼Œå¯¹äºä¸Nativeå¹³å°å±‚çš„é€šä¿¡ï¼Œæ¯ä¸ªä¸šåŠ¡ç»„ä»¶å¯¹åº”ä¸€ä¸ªChannelï¼Œå½“ç„¶å†…éƒ¨è¿˜å¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„Channelè¿›è¡Œåˆ’åˆ†ï¼Œè¿™ä¸ªChannelä¸»è¦æ˜¯è´Ÿè´£Nativeå±‚æœåŠ¡çš„æä¾›ï¼Œè®©Flutterå±‚æ¶ˆè´¹ã€‚è€Œå¯¹äºNativeå±‚è°ƒç”¨Flutterå±‚çš„Apiï¼Œåº”è¯¥å°½å¯èƒ½å°‘ï¼Œéœ€è¦è°ƒä¹Ÿåªæœ‰å‡ºç°ä¸€äº›å€¼å›è°ƒæ—¶ã€‚

å› ä¸ºFlutterçš„å‡ºç°æœ€æœ¬è´¨çš„å°±æ˜¯ä¸€æ¬¡å¼€å‘ä¸¤ç«¯è¿è¡Œï¼Œè€Œå¦‚æœæœ‰å¤ªå¤šè¿™ç§ä¾èµ–äºå¹³å°å±‚çš„å®ç°ï¼Œåè€Œå‡ºç°è¿èƒŒäº†ï¼Œæœ€ååªæ˜¯UIå†™äº†ä¸€ä»½è€Œå·²ã€‚å¯¹äºå¹³å°å±‚çš„å®ç°ä¹Ÿè¦å°½é‡ä¿æŒä¸€ä¸ªåŸåˆ™ï¼Œå³ï¼š

å°½é‡è®©Nativeå¹³å°å±‚æˆä¸ºæœåŠ¡å±‚ï¼Œè®©Flutterå±‚æˆä¸ºæ¶ˆè´¹å±‚è°ƒç”¨Nativeå±‚çš„æœåŠ¡ï¼Œå³Dartè°ƒç”¨Nativeçš„Apiï¼Œè¿™æ ·å½“ä¸¤ç«¯å¼€å‘äººå‘˜ç¼–å†™å¥½ä¸€è‡´åŸºç¡€çš„æœåŠ¡æ¥å£åï¼ŒFlutterçš„å¼€å‘äººå‘˜å³å¯å¹³æ»‘ä½¿ç”¨å’Œå¼€å‘ã€‚

## ä¸ƒã€ååº

å¯¹äºç°æœ‰å·¥ç¨‹ä½¿ç”¨Flutterè¿›è¡Œæ··åˆå¼€å‘ï¼Œå‘ç‚¹è¿˜æ˜¯æœ‰çš„ï¼Œæ¯”å¦‚æ€§èƒ½ã€é¡µé¢æ ˆç®¡ç†ç­‰æ–¹é¢ï¼ŒåŠ ä¸Šç›®å‰Flutterä¸Šä¸€äº›åŸºç¡€åº“ä¸æˆç†Ÿï¼Œå¯¹äºé¡¹ç›®å†…çš„é‡è¦é¡µé¢ä»¥åŠåŠ¨æ€åŒ–å¼ºåº¦æ¯”è¾ƒé«˜çš„é¡µé¢ï¼Œç›®å‰è¿˜æ˜¯ä¸å»ºè®®ä½¿ç”¨Flutterè¿›è¡Œå¼€å‘ï¼Œå¦‚æœè¦ä½¿ç”¨ä¹Ÿé¡»åšå¥½é™çº§æ–¹æ¡ˆï¼Œç›¸åå¯ä»¥ä½¿ç”¨ç¨å¾®è½»é‡çº§ç‚¹çš„é¡µé¢ï¼Œä¸”åœ¨è®¾è®¡æ—¶å¯¹äºFlutterä¸Nativeå±‚çš„é€šä¿¡ï¼Œåº”è¯¥è®©Flutterä½œä¸ºæ¶ˆè´¹å±‚æ¶ˆè´¹Nativeå±‚æä¾›çš„æœåŠ¡ï¼ŒNativeç«¯åº”åšå°½é‡å°‘çš„æ”¹åŠ¨ç­‰ç­‰ã€‚ä¸çº¯åŸç”Ÿå¼€å‘æˆ–çº¯ Flutter å¼€å‘ç›¸æ¯”ï¼Œæ··åˆå¼€å‘ç”±äºéœ€è¦æ‰“é€šåŸç”Ÿå’Œ Flutter çš„æ•°æ®å’ŒæœåŠ¡ï¼Œéœ€è¦æœ‰å¤§é‡æ¡¥æ¥å®ç°ï¼Œå„ä¸ªæ¨¡å—äº’ç›¸åä½œä¹Ÿéœ€è¦è€ƒè™‘å„ç§å¼‚å¸¸æˆ–é™çº§çš„æƒ…å†µã€‚


å‚è€ƒï¼š
å°† Flutter module é›†æˆåˆ° Android é¡¹ç›® https://flutter.cn/docs/development/add-to-app/android/project-setup
å°† Flutter module é›†æˆåˆ° iOS é¡¹ç›® https://flutter.cn/docs/development/add-to-app/ios/project-setup
åœ¨ Android åº”ç”¨ä¸­æ·»åŠ  Flutter é¡µé¢https://flutter.cn/docs/development/add-to-app/android/add-flutter-screen
åœ¨ iOS åº”ç”¨ä¸­æ·»åŠ  Flutter é¡µé¢ https://flutter.cn/docs/development/add-to-app/ios/add-flutter-screen
Add-to-App Samples https://github.com/flutter/samples/blob/beface247a/add_to_app/README.md
